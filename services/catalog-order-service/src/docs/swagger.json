{
  "openapi": "3.0.3",
  "info": {
    "title": "Catalog Service API (documentación)",
    "version": "1.0.0",
    "description": "Especificación OpenAPI para el servicio de catálogos, productos, inventario, carrito y órdenes. Rutas públicas, de usuario y de administrador con autenticación Bearer JWT."
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "Server local"
    }
  ],
  "tags": [
    { "name": "Public", "description": "Endpoints públicos (productos y categorías)" },
    { "name": "Admin", "description": "Endpoints protegidos para administradores" },
    { "name": "User", "description": "Endpoints protegidos para usuarios (carrito, órdenes)" },
    { "name": "Inventory", "description": "Operaciones de inventario (admin)" }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Token JWT: `Authorization: Bearer <token>`\nRutas de admin requieren rol `admin`. Rutas de user requieren rol `user`."
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "properties": {
          "error": { "type": "string" },
          "details": { "type": "object", "additionalProperties": true }
        }
      },
      "Category": {
        "type": "object",
        "properties": {
          "id": { "type": "integer", "example": 1 },
          "name": { "type": "string", "example": "Ropa" },
          "slug": { "type": "string", "example": "ropa" },
          "description": { "type": "string", "example": "Categoría de ropa" },
          "createdAt": { "type": "string", "format": "date-time" },
          "updatedAt": { "type": "string", "format": "date-time" }
        },
        "required": ["name"]
      },
      "Product": {
        "type": "object",
        "properties": {
          "id": { "type": "integer", "example": 100 },
          "name": { "type": "string", "example": "Camiseta básica" },
          "slug": { "type": "string", "example": "camiseta-basica" },
          "description": { "type": "string", "example": "Camiseta 100% algodón" },
          "price": { "type": "number", "format": "float", "example": 29.99 },
          "currency": { "type": "string", "example": "USD" },
          "categoryId": { "type": "integer", "example": 1 },
          "images": { "type": "array", "items": { "type": "string", "format": "uri" } },
          "metadata": { "type": "object", "additionalProperties": true },
          "createdAt": { "type": "string", "format": "date-time" },
          "updatedAt": { "type": "string", "format": "date-time" }
        },
        "required": ["name", "price", "categoryId"]
      },
      "Inventory": {
        "type": "object",
        "properties": {
          "productId": { "type": "integer" },
          "available": { "type": "integer", "example": 10 },
          "reserved": { "type": "integer", "example": 2 },
          "committed": { "type": "integer", "example": 0 }
        }
      },
      "CartItem": {
        "type": "object",
        "properties": {
          "itemId": { "type": "integer", "example": 555 },
          "productId": { "type": "integer", "example": 100 },
          "name": { "type": "string" },
          "price": { "type": "number", "format": "float" },
          "quantity": { "type": "integer", "example": 2 },
          "subtotal": { "type": "number", "format": "float" }
        }
      },
      "Cart": {
        "type": "object",
        "properties": {
          "userId": { "type": "integer" },
          "items": { "type": "array", "items": { "$ref": "#/components/schemas/CartItem" } },
          "total": { "type": "number", "format": "float" }
        }
      },
      "OrderItem": {
        "type": "object",
        "properties": {
          "productId": { "type": "integer" },
          "name": { "type": "string" },
          "price": { "type": "number", "format": "float" },
          "quantity": { "type": "integer" }
        }
      },
      "Order": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "userId": { "type": "integer" },
          "items": { "type": "array", "items": { "$ref": "#/components/schemas/OrderItem" } },
          "total": { "type": "number", "format": "float" },
          "status": { "type": "string", "enum": ["pending","paid","cancelled","shipped","failed"], "example": "pending" },
          "createdAt": { "type": "string", "format": "date-time" }
        }
      },
      "PaginationQuery": {
        "type": "object",
        "properties": {
          "page": { "type": "integer", "default": 1 },
          "limit": { "type": "integer", "default": 20 },
          "q": { "type": "string" }
        }
      },
      "AuthUser": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "email": { "type": "string" },
          "role": { "type": "string" }
        }
      }
    }
  },
  "paths": {
    
    "/api/categories": {
      "get": {
        "tags": ["Public"],
        "summary": "Listar categorías públicas",
        "parameters": [
          { "name": "page", "in": "query", "schema": { "type": "integer" } },
          { "name": "limit", "in": "query", "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Lista de categorías",
            "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Category" } } } }
          }
        }
      }
    },
    "/api/categories/{id}": {
      "get": {
        "tags": ["Public"],
        "summary": "Obtener categoría por id",
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "responses": {
          "200": { "description": "Categoría", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Category" } } } },
          "404": { "description": "No encontrada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/api/products": {
      "get": {
        "tags": ["Public"],
        "summary": "Listar productos (público)",
        "parameters": [
          { "name": "page", "in": "query", "schema": { "type": "integer" } },
          { "name": "limit", "in": "query", "schema": { "type": "integer" } },
          { "name": "categoryId", "in": "query", "schema": { "type": "integer" } },
          { "name": "q", "in": "query", "schema": { "type": "string" } }
        ],
        "responses": {
          "200": { "description": "Lista de productos", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Product" } } } } }
        }
      }
    },
    "/api/products/{id}": {
      "get": {
        "tags": ["Public"],
        "summary": "Obtener producto por id",
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "responses": {
          "200": { "description": "Producto", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Product" } } } },
          "404": { "description": "No encontrada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/api/products/slug/{slug}": {
      "get": {
        "tags": ["Public"],
        "summary": "Obtener producto por slug",
        "parameters": [ { "name": "slug", "in": "path", "required": true, "schema": { "type": "string" } } ],
        "responses": {
          "200": { "description": "Producto por slug", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Product" } } } },
          "404": { "description": "No encontrada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    " /api/admin/category": {},

    "/api/admin/category": {
      "post": {
        "tags": ["Admin"],
        "summary": "Crear categoría (admin)",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "name": { "type": "string" }, "slug": { "type": "string" }, "description": { "type": "string" } }, "required": ["name"] } } } },
        "responses": {
          "201": { "description": "Categoría creada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Category" } } } },
          "401": { "description": "No autorizado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "403": { "description": "Prohibido (rol admin requerido)", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      },
      "put": {
        "summary": "(Nota) PUT en esta ruta no usada - use /api/admin/category/{id}",
        "responses": { "405": { "description": "Method not allowed" } }
      }
    },
    "/api/admin/category/{id}": {
      "put": {
        "tags": ["Admin"],
        "summary": "Actualizar categoría por id (admin)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "name": { "type": "string" }, "slug": { "type": "string" }, "description": { "type": "string" } } } } } },
        "responses": {
          "200": { "description": "Categoría actualizada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Category" } } } },
          "401": { "description": "No autorizado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "403": { "description": "Prohibido (rol admin requerido)", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "404": { "description": "No encontrada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      },
      "delete": {
        "tags": ["Admin"],
        "summary": "Eliminar categoría por id (admin)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "responses": {
          "204": { "description": "Eliminado" },
          "401": { "description": "No autorizado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "403": { "description": "Prohibido (rol admin requerido)", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },

    "/api/admin/products": {
      "post": {
        "tags": ["Admin"],
        "summary": "Crear producto (admin)",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Product" } } } },
        "responses": {
          "201": { "description": "Producto creado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Product" } } } },
          "400": { "description": "Bad Request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/api/admin/products/{id}": {
      "put": {
        "tags": ["Admin"],
        "summary": "Actualizar producto por id (admin)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Product" } } } },
        "responses": {
          "200": { "description": "Producto actualizado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Product" } } } },
          "404": { "description": "No encontrado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      },
      "delete": {
        "tags": ["Admin"],
        "summary": "Eliminar producto por id (admin)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "responses": { "204": { "description": "Eliminado" }, "404": { "description": "No encontrado" } }
      }
    },
    "/api/admin/products/{id}/inventory": {
      "post": {
        "tags": ["Admin","Inventory"],
        "summary": "Upsert inventario de producto (admin)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "available": { "type": "integer" }, "reserved": { "type": "integer" } } } } } },
        "responses": { "200": { "description": "Inventario actualizado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Inventory" } } } } }
      }
    },

    "/api/admin/inventory/{productId}": {
      "get": {
        "tags": ["Admin","Inventory"],
        "summary": "Obtener inventario por productId (admin)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "productId", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "responses": { "200": { "description": "Inventario", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Inventory" } } } }, "404": { "description": "No encontrado" } }
      }
    },
    "/api/admin/inventory/{productId}/reserve": {
      "post": {
        "tags": ["Admin","Inventory"],
        "summary": "Reservar inventario (admin)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "productId", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "quantity": { "type": "integer" } }, "required": ["quantity"] } } } },
        "responses": { "200": { "description": "Reservado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Inventory" } } } }, "400": { "description": "Insuficiente" } }
      }
    },
    "/api/admin/inventory/{productId}/release": {
      "post": {
        "tags": ["Admin","Inventory"],
        "summary": "Liberar reserva de inventario (admin)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "productId", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "quantity": { "type": "integer" } }, "required": ["quantity"] } } } },
        "responses": { "200": { "description": "Liberado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Inventory" } } } } }
      }
    },
    "/api/admin/inventory/{productId}/commit": {
      "post": {
        "tags": ["Admin","Inventory"],
        "summary": "Confirmar (commit) reserva de inventario (admin)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "productId", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "quantity": { "type": "integer" } }, "required": ["quantity"] } } } },
        "responses": { "200": { "description": "Commit realizado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Inventory" } } } } }
      }
    },

    "/api/user/cart": {
      "get": {
        "tags": ["User"],
        "summary": "Obtener carrito del usuario (auth required)",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "Carrito del usuario", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Cart" } } } }, "401": { "description": "No autorizado" } }
      }
    },
    "/api/user/cart/items": {
      "post": {
        "tags": ["User"],
        "summary": "Agregar o actualizar item en carrito (auth user)",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "productId": { "type": "integer" }, "quantity": { "type": "integer" } }, "required": ["productId","quantity"] } } } },
        "responses": { "200": { "description": "Item agregado/actualizado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Cart" } } } }, "400": { "description": "Bad request" } }
      }
    },
    "/api/user/cart/items/{itemId}": {
      "put": {
        "tags": ["User"],
        "summary": "Actualizar cantidad de item en carrito",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "itemId", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "quantity": { "type": "integer" } }, "required": ["quantity"] } } } },
        "responses": { "200": { "description": "Item actualizado", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Cart" } } } }, "404": { "description": "Item no encontrado" } }
      },
      "delete": {
        "tags": ["User"],
        "summary": "Remover item del carrito",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "itemId", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "responses": { "204": { "description": "Eliminado" }, "404": { "description": "Item no encontrado" } }
      }
    },
    "/api/user/cart/checkout": {
      "post": {
        "tags": ["User"],
        "summary": "Checkout del carrito (crea orden)",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": false, "content": { "application/json": { "schema": { "type": "object", "properties": { "paymentMethod": { "type": "string" }, "shippingAddress": { "type": "object", "additionalProperties": true } } } } } },
        "responses": { "201": { "description": "Orden creada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Order" } } } }, "400": { "description": "Carrito vacío o error" } }
      }
    },

    "/api/user/orders": {
      "get": {
        "tags": ["User"],
        "summary": "Listar órdenes del usuario",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "Lista de órdenes", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Order" } } } } } }
      },
      "post": {
        "tags": ["User"],
        "summary": "Crear orden manual (si aplica)",
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "type": "object", "properties": { "items": { "type": "array", "items": { "$ref": "#/components/schemas/OrderItem" } }, "paymentMethod": { "type": "string" } }, "required": ["items"] } } } },
        "responses": { "201": { "description": "Orden creada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Order" } } } } }
      }
    },
    "/api/user/orders/{id}": {
      "get": {
        "tags": ["User"],
        "summary": "Obtener orden por id",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "responses": { "200": { "description": "Orden", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Order" } } } }, "404": { "description": "No encontrada" } }
      }
    },
    "/api/user/orders/{id}/pay": {
      "post": {
        "tags": ["User"],
        "summary": "Pagar orden (simulado)",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "requestBody": { "required": false, "content": { "application/json": { "schema": { "type": "object", "properties": { "paymentReference": { "type": "string" } } } } } },
        "responses": { "200": { "description": "Orden pagada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Order" } } } }, "400": { "description": "Pago fallido" } }
      }
    },
    "/api/user/orders/{id}/cancel": {
      "post": {
        "tags": ["User"],
        "summary": "Cancelar orden",
        "security": [{ "bearerAuth": [] }],
        "parameters": [ { "name": "id", "in": "path", "required": true, "schema": { "type": "integer" } } ],
        "responses": { "200": { "description": "Orden cancelada", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Order" } } } }, "400": { "description": "No se puede cancelar" } }
      }
    }
  },
  "security": []
}
